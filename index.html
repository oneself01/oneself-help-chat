<script>
  // ğŸ”— Cloudflare Workers ã®URLï¼ˆè‡ªåˆ†ã®ã‚‚ã®ã«åˆã‚ã›ã¦ã­ï¼‰
  const WORKER_ENDPOINT = "https://aged-mountain-a919.mabekento.workers.dev";

  const chatLog  = document.getElementById("chat-log");
  const form     = document.getElementById("chat-form");
  const input    = document.getElementById("user-input");
  const sendBtn  = document.getElementById("send-btn");

  // å¹ãå‡ºã—ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
  function addBubble(text, role) {
    const row   = document.createElement("div");
    row.className = "message-row " + role;

    const bubble = document.createElement("div");
    bubble.className = "bubble";
    bubble.textContent = text;

    // å›ç­”å´ã ã‘ã‚¯ãƒã‚¢ã‚¤ã‚³ãƒ³ã‚’ä»˜ã‘ã‚‹ä¾‹
    if (role === "bot") {
      const icon = document.createElement("div");
      icon.className = "avatar";
      icon.innerHTML = "ğŸ»"; // ã“ã“ã‚’<img>ã«ã—ã¦ã‚¯ãƒç”»åƒã§ã‚‚OK
      row.appendChild(icon);
    }

    row.appendChild(bubble);
    chatLog.appendChild(row);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  // æœ€åˆã®æ¡ˆå†…ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒæ¬²ã—ã‘ã‚Œã°ã“ã“ã«æ›¸ã
  // addBubble("ç¤¾å†…æ¥­å‹™ã«ã¤ã„ã¦è‡ªç”±ã«è³ªå•ã—ã¦ãã ã•ã„ã€‚", "bot");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const text = input.value.trim();
    if (!text) return;

    // è‡ªåˆ†ã®å¹ãå‡ºã—
    addBubble(text, "user");
    input.value = "";
    input.focus();

    // ã€Œè€ƒãˆä¸­â€¦ã€å¹ãå‡ºã—
    const thinkingRow = document.createElement("div");
    thinkingRow.className = "message-row bot";
    const thinkingBubble = document.createElement("div");
    thinkingBubble.className = "bubble thinking";
    thinkingBubble.textContent = "è€ƒãˆä¸­â€¦";
    thinkingRow.appendChild(thinkingBubble);
    chatLog.appendChild(thinkingRow);
    chatLog.scrollTop = chatLog.scrollHeight;

    sendBtn.disabled = true;

    try {
      const res = await fetch(
        `${WORKER_ENDPOINT}?q=${encodeURIComponent(text)}`
      );

      const answerText = await res.text();

      // è€ƒãˆä¸­ã‚’æ¶ˆã—ã¦ã€æœ¬å›ç­”ã‚’è¿½åŠ 
      thinkingRow.remove();
      addBubble(answerText, "bot");
    } catch (err) {
      console.error(err);
      thinkingRow.remove();
      addBubble("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚", "bot");
    } finally {
      sendBtn.disabled = false;
    }
  });
</script>
